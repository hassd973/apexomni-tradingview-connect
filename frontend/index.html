<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Ice King Dashboard: Live crypto market analytics powered by CoinMarketCap, Etherscan, and TradingView.">
  <meta name="keywords" content="crypto, dashboard, Ice King, Adventure Time, trading, analytics">
  <meta name="author" content="xAI">
  <title>‚ùÑÔ∏è ICE KING üåéü§ë DASHBOARD üëë</title>
  <link rel="icon" type="image/png" href="https://i.imgur.com/7YkZ3Xh.png">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Limelight&family=Fira+Code:wght@400;700&display=swap" rel="stylesheet">
  <script type="module" src="https://unpkg.com/@splinetool/viewer@1.9.96/build/spline-viewer.js"></script>
  <script src="https://s3.tradingview.com/tv.js" async></script>
  <style>
    body {
      font-family: 'Fira Code', monospace;
      background: #1e2727;
      color: #e0f7fa;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      line-height: 1.6;
    }
    h1, h2, h3 {
      font-family: 'Limelight', cursive;
      color: #e0f7fa;
      text-shadow: 0 0 8px rgba(0, 204, 0, 0.3);
    }
    .spline-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0.5;
      z-index: -2;
      pointer-events: none;
    }
    spline-viewer {
      width: 100%;
      height: 100%;
    }
    .snowflake {
      position: absolute;
      color: #e0f7fa;
      font-size: 6px;
      animation: snowflake linear infinite;
      pointer-events: none;
      z-index: -1;
    }
    @keyframes snowflake {
      0% { transform: translate(0, 0) rotate(0deg); opacity: 0.6; }
      100% { transform: translate(calc(-20px + var(--drift)), 100vh) rotate(360deg); opacity: 0; }
    }
    .particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: -1;
    }
    .star {
      position: absolute;
      width: 1px;
      height: 1px;
      background: rgba(0, 204, 0, 0.3);
      border-radius: 50%;
      animation: float 15s infinite linear;
    }
    @keyframes float {
      0% { transform: translate(0, 0); opacity: 0; }
      50% { opacity: 0.4; }
      100% { transform: translate(50px, -50px); opacity: 0; }
    }
    header, footer {
      background: rgba(30, 39, 39, 0.8);
      padding: 1rem;
      border-bottom: 1px solid rgba(0, 204, 0, 0.1);
    }
    footer {
      border-top: 1px solid rgba(0, 204, 0, 0.1);
    }
    .chart-container {
      position: relative;
      width: 100%;
      height: calc(100vh - 320px);
      min-height: 250px;
      max-height: 600px;
      border: 1px solid rgba(0, 204, 0, 0.2);
      border-radius: 6px;
    }
    .tradingview-widget-container {
      position: absolute !important;
      width: 100% !important;
      height: 100% !important;
    }
    .chart-loading {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      background: rgba(30, 39, 39, 0.5);
      z-index: 10;
      color: #00b7eb;
      font-size: 0.875rem;
    }
    #chart-container-modal {
      height: calc(90vh - 180px) !important;
      min-height: 300px;
      max-height: 700px;
    }
    @media (max-height: 600px) {
      .chart-container { height: 200px; }
      #chart-container-modal { height: 250px !important; }
    }
    @media (min-width: 1024px) {
      .chart-container { max-height: 600px; }
      #chart-container-modal { max-height: 700px; }
    }
    .chart-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(30, 39, 39, 0.7);
      z-index: 50;
      justify-content: center;
      align-items: center;
      overflow-y: auto;
    }
    .chart-modal.active { display: flex; }
    .chart-modal-content {
      background: #232e2e;
      padding: 1rem;
      border: 1px solid rgba(0, 204, 0, 0.2);
      border-radius: 6px;
      width: 95%;
      max-width: 1200px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    main {
      flex: 1;
      padding: 1rem;
    }
    section {
      background: #232e2e;
      border: 1px solid rgba(0, 204, 0, 0.2);
      border-radius: 6px;
      padding: 1rem;
      min-width: 0;
      cursor: move;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    @media (max-width: 639px) {
      section { cursor: default; }
    }
    section.dragging {
      opacity: 0.8;
      transform: scale(0.98);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      z-index: 100;
    }
    section:hover {
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    ul {
      scrollbar-width: thin;
      scrollbar-color: #00b7eb #232e2e;
      list-style: none;
      padding: 0;
    }
    ul::-webkit-scrollbar {
      width: 6px;
    }
    ul::-webkit-scrollbar-track {
      background: #232e2e;
    }
    ul::-webkit-scrollbar-thumb {
      background: #00b7eb;
      border-radius: 4px;
    }
    #token-list, #profit-pairs, #log-list, #chat-list, #gas-heatmap-list {
      max-height: 50vh;
      overflow-y: auto;
      padding-right: 4px;
    }
    @media (min-width: 640px) {
      #token-list, #profit-pairs, #log-list, #chat-list, #gas-heatmap-list {
        max-height: 60vh;
      }
    }
    #token-list li {
      display: flex;
      flex-direction: column;
      padding: 0.75rem;
      border-radius: 6px;
      margin-bottom: 0.5rem;
      transition: all 0.3s ease;
      cursor: pointer;
      font-size: 0.875rem;
      background: rgba(30, 39, 39, 0.5);
    }
    #token-list li:hover {
      background: rgba(0, 204, 0, 0.1);
      transform: translateX(2px);
    }
    #token-list li.selected-token {
      border: 1px solid #ffbb33;
      background: rgba(255, 187, 51, 0.1);
    }
    #token-list .metric {
      font-size: 0.75rem;
      color: #a0a0a0;
    }
    #token-list .performance {
      font-size: 0.875rem;
      font-weight: 700;
    }
    #profit-pairs .metric {
      font-size: 0.75rem;
      color: #a0a0a0;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.02); }
      100% { transform: scale(1); }
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in { animation: fadeIn 0.5s ease-in; }
    .hover-transition { transition: all 0.3s ease; }
    .hover-transition:hover { background-color: rgba(255, 187, 51, 0.1); }
    .marquee-container {
      background: rgba(30, 39, 39, 0.5);
      border: 1px solid rgba(0, 204, 0, 0.2);
      overflow: hidden;
      white-space: nowrap;
      padding: 0.5rem 0;
      margin-top: 0.5rem;
      border-radius: 6px;
    }
    .marquee {
      display: inline-block;
      animation: marquee 80s linear infinite;
      animation-play-state: running;
    }
    @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
    .marquee span {
      margin-right: 1rem;
      font-size: 0.875rem;
      color: #e0f7fa;
    }
    @media (min-width: 640px) { .marquee span { font-size: 0.875rem; } }
    .marquee-container:hover .marquee { animation-play-state: paused; }
    button, #chat-send, #toggle-data-source, #toggle-debug, #toggle-indicator-header, #toggle-indicator-modal {
      background-color: #00b7eb;
      color: #1e2727;
      border: 1px solid rgba(0, 183, 235, 0.3);
      font-size: 0.875rem;
      border-radius: 6px;
      padding: 0.5rem 1rem;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }
    button:hover, #chat-send:hover, #toggle-data-source:hover, #toggle-debug:hover, #toggle-indicator-header:hover, #toggle-indicator-modal:hover {
      background-color: #ffbb33;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .timeframe-btn.active {
      background-color: #ffbb33;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    #chat-input {
      background: rgba(30, 39, 39, 0.5);
      border: 1px solid rgba(0, 204, 0, 0.2);
      color: #e0f7fa;
      width: 100%;
      padding: 0.5rem;
      border-radius: 6px;
      font-size: 0.875rem;
    }
    #chat-input:focus {
      outline: none;
      border-color: #ffbb33;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .loader {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 0.5rem;
    }
    .loader::after {
      content: '';
      width: 14px;
      height: 14px;
      border: 2px solid #00b7eb;
      border-top: 2px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .typewriter {
      display: inline-block;
      overflow: hidden;
      white-space: nowrap;
      border-right: 2px solid #00b7eb;
      animation: typing 4s steps(30, end), blink-caret 0.75s step-end infinite;
    }
    @keyframes typing {
      from { width: 0; }
      to { width: 100%; }
    }
    @keyframes blink-caret {
      from, to { border-color: transparent; }
      50% { border-color: #00b7eb; }
    }
    .title-box {
      color: #e0f7fa;
      text-align: center;
      margin-bottom: 1rem;
      font-size: 1rem;
      background: rgba(30, 39, 39, 0.5);
      border: 1px solid rgba(0, 204, 0, 0.2);
      border-radius: 6px;
      padding: 0.75rem;
      animation: pulse 4s infinite;
    }
    @media (min-width: 640px) {
      .title-box { font-size: 1.25rem; }
    }
    #chart-title-header, #chart-title-modal {
      text-align: center;
      padding: 0.5rem;
      border-radius: 6px;
      background: rgba(30, 39, 39, 0.5);
      font-size: 0.875rem;
    }
    @media (min-width: 640px) {
      #chart-title-header, #chart-title-modal { font-size: 1rem; }
    }
    [data-tooltip] { position: relative; }
    [data-tooltip]:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 183, 235, 0.8);
      color: #1e2727;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      white-space: nowrap;
      z-index: 60;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    #profit-pairs .top-pair { color: #00cc00; }
    #profit-pairs .bottom-pair { color: #cc0000; }
    .gas-heatmap-section {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .gas-heatmap-title {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    #gas-heatmap-canvas {
      width: 100%;
      height: 20vh;
      border: 1px solid rgba(0, 204, 0, 0.2);
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    @media (min-width: 640px) {
      #gas-heatmap-canvas { height: 25vh; }
    }
    #gas-heatmap-legend {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-top: 0.5rem;
      font-size: 0.75rem;
    }
    @media (min-width: 640px) {
      #gas-heatmap-legend { font-size: 0.875rem; }
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    .legend-color {
      width: 10px;
      height: 10px;
      border-radius: 2px;
    }
  </style>
</head>
<body class="text-white min-h-screen flex flex-col overflow-x-hidden overflow-y-auto scrollbar-thin scrollbar-track-gray-900 scrollbar-thumb-blue-600">
  <div class="spline-bg">
    <spline-viewer url="https://prod.spline.design/uQ3gwQojoWDY4Abr/scene.splinecode"></spline-viewer>
  </div>
  <div class="particles" id="particles"></div>
  <header class="w-full flex justify-center items-center">
    <div class="w-full max-w-[98vw] mx-auto px-4">
      <div class="title-box">
        <h1 class="text-lg md:text-xl">‚ùÑÔ∏è ICE KING DASHBOARD</h1>
      </div>
      <p class="text-sm text-center typewriter">Live Crypto Analytics</p>
      <div class="chart-wrapper w-full">
        <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
          <div class="flex flex-wrap space-x-2 gap-2">
            <button id="header-timeframe-1min" class="timeframe-btn" data-interval="1" data-tooltip="1-minute chart">1M</button>
            <button id="header-timeframe-5min" class="timeframe-btn" data-interval="5" data-tooltip="5-minute chart">5M</button>
            <button id="header-timeframe-15min" class="timeframe-btn" data-interval="15" data-tooltip="15-minute chart">15M</button>
            <button id="header-timeframe-1hr" class="timeframe-btn" data-interval="60" data-tooltip="1-hour chart">1H</button>
            <button id="header-timeframe-1d" class="timeframe-btn active" data-interval="D" data-tooltip="Daily chart">1D</button>
          </div>
          <div class="flex flex-wrap space-x-2 gap-2">
            <button id="toggle-indicator-header" data-tooltip="Toggle ICE KING indicator">Toggle Indicator</button>
            <button id="toggle-sticky-header" data-tooltip="Open chart in modal">Dock Chart</button>
            <button id="toggle-data-source" data-tooltip="Switch data source">Real Data</button>
            <button id="toggle-debug" data-tooltip="Toggle debug mode">Debug</button>
          </div>
        </div>
        <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
          <div id="live-price-header" class="text-sm">> Live Price: Loading...</div>
        </div>
        <div id="chart-container-header" class="chart-container">
          <div class="chart-loading">
            <div class="loader"></div>
            <div class="ml-2">Loading chart...</div>
          </div>
        </div>
        <h3 id="chart-title-header" class="mt-2">Loading...</h3>
        <div class="marquee-container">
          <div class="marquee" id="ticker-marquee-header">
            <span>BTC: $61,234.56 (+2.34%)</span>
            <span>ETH: $3,456.78 (+1.23%)</span>
            <span>SOL: $145.67 (+5.67%)</span>
            <span>XRP: $0.5678 (-0.45%)</span>
            <span>ADA: $0.4567 (+3.21%)</span>
          </div>
        </div>
      </div>
    </div>
  </header>
  <div class="chart-modal" id="chart-modal">
    <div class="chart-modal-content">
      <div class="chart-wrapper w-full">
        <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
          <div class="flex flex-wrap space-x-2 gap-2">
            <button id="modal-timeframe-1min" class="timeframe-btn" data-interval="1" data-tooltip="1-minute chart">1M</button>
            <button id="modal-timeframe-5min" class="timeframe-btn" data-interval="5" data-tooltip="5-minute chart">5M</button>
            <button id="modal-timeframe-15min" class="timeframe-btn" data-interval="15" data-tooltip="15-minute chart">15M</button>
            <button id="modal-timeframe-1hr" class="timeframe-btn" data-interval="60" data-tooltip="1-hour chart">1H</button>
            <button id="modal-timeframe-1d" class="timeframe-btn active" data-interval="D" data-tooltip="Daily chart">1D</button>
          </div>
          <div class="flex flex-wrap space-x-2 gap-2">
            <button id="toggle-indicator-modal" data-tooltip="Toggle ICE KING indicator">Toggle Indicator</button>
            <button id="toggle-sticky-modal" data-tooltip="Close chart modal">Undock Chart</button>
          </div>
        </div>
        <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
          <div id="live-price-modal" class="text-sm">> Live Price: Loading...</div>
        </div>
        <div id="chart-container-modal" class="chart-container">
          <div class="chart-loading">
            <div class="loader"></div>
            <div class="ml-2">Loading chart...</div>
          </div>
        </div>
        <h3 id="chart-title-modal" class="mt-2">Loading...</h3>
        <div class="marquee-container">
          <div class="marquee" id="ticker-marquee-modal">
            <span>BTC: $61,234.56 (+2.34%)</span>
            <span>ETH: $3,456.78 (+1.23%)</span>
            <span>SOL: $145.67 (+5.67%)</span>
            <span>XRP: $0.5678 (-0.45%)</span>
            <span>ADA: $0.4567 (+3.21%)</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  <main class="flex-1 p-4 w-full max-w-[98vw] mx-auto grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4" id="module-grid">
    <section class="rounded-lg" draggable="true">
      <h2 class="text-lg md:text-xl mb-3 typewriter">> Tokens</h2>
      <div id="loader-tokens" class="loader text-center text-gray-500 text-sm">> Loading...</div>
      <ul id="token-list" class="space-y-2 text-sm"></ul>
      <div class="mt-4">
        <h3 class="text-base md:text-lg mb-2 typewriter">> Performers</h3>
        <ul id="profit-pairs" class="space-y-2 text-sm"></ul>
      </div>
      <div class="mt-4">
        <h3 class="text-base md:text-lg mb-2 typewriter">> Top USDT Pairs</h3>
        <ul id="top-pairs" class="text-sm text-gray-500 flex flex-wrap gap-2"></ul>
      </div>
    </section>
    <section class="rounded-lg gas-heatmap-section" draggable="true">
      <h2 class="text-lg md:text-xl mb-3 gas-heatmap-title typewriter">> ETH Gas Heatmap</h2>
      <div id="loader-gas" class="loader text-center text-gray-500 text-sm">> Loading...</div>
      <canvas id="gas-heatmap-canvas"></canvas>
      <div id="gas-heatmap-legend">
        <div class="legend-item"><div class="legend-color" style="background: #00cc00"></div><span>Safe</span></div>
        <div class="legend-item"><div class="legend-color" style="background: #ffbb33"></div><span>Propose</span></div>
        <div class="legend-item"><div class="legend-color" style="background: #cc0000"></div><span>Fast</span></div>
      </div>
      <ul id="gas-heatmap-list" class="space-y-2 text-sm mt-2"></ul>
    </section>
    <section class="rounded-lg" draggable="true">
      <h2 class="text-lg md:text-xl mb-3 typewriter">> Live Logs</h2>
      <div id="loader-logs" class="loader text-center text-gray-500 text-sm">> Loading...</div>
      <ul id="log-list" class="space-y-2 text-sm"></ul>
    </section>
    <section class="rounded-lg" draggable="true">
      <h2 class="text-lg md:text-xl mb-3 typewriter">> Trading Bot</h2>
      <div class="mt-4">
        <h3 class="text-base md:text-lg mb-2">System Logs</h3>
        <div id="live-logs-container" class="max-h-[30vh] overflow-y-auto scrollbar-thin scrollbar-track-gray-800 scrollbar-thumb-blue-600 p-2 bg-gray-900 rounded text-sm">
        </div>
      </div>
      <div id="loader-chat" class="loader text-center text-gray-500 text-sm">> Loading...</div>
      <div id="chat-list" class="flex-grow overflow-y-auto p-2 space-y-2 max-h-[50vh] scroll-smooth scrollbar-thin scrollbar-track-gray-800 scrollbar-thumb-blue-600 text-sm">
      </div>
      <div class="mt-4 flex flex-col sm:flex-row gap-2">
        <input id="chat-input" type="text" placeholder="Ask Grok..." class="p-2 rounded" aria-label="Chat input" data-tooltip="Type your query">
        <button id="chat-send" class="px-4 py-2 rounded" aria-label="Send chat message" data-tooltip="Send message">Send</button>
      </div>
    </section>
  </main>
  <footer class="text-center text-gray-500 text-sm">
    <p class="typewriter">Powered by CoinMarketCap, Etherscan & TradingView</p>
  </footer>
  <script>
    // Particle effect
    const particleContainer = document.getElementById('particles');
    for (let i = 0; i < 50; i++) {
      const particle = document.createElement('div');
      particle.className = 'star';
      particle.style.left = `${Math.random() * 100}%`;
      particle.style.top = `${Math.random() * 100}%`;
      particle.style.animationDelay = `${Math.random() * 15}s`;
      particleContainer.appendChild(particle);
    }

    // Snowflake effect
    for (let i = 0; i < 50; i++) {
      const snowflake = document.createElement('div');
      snowflake.className = 'snowflake';
      snowflake.textContent = '‚ùÑÔ∏è';
      snowflake.style.left = `${Math.random() * 100}%`;
      snowflake.style.top = `${-10 + Math.random() * 10}vh`;
      snowflake.style.animationDelay = `${Math.random() * 5}s`;
      snowflake.style.animationDuration = `${10 + Math.random() * 5}s`;
      snowflake.style.setProperty('--drift', `${-20 + Math.random() * 40}px`);
      document.body.appendChild(snowflake);
    }

    // Drag-and-drop
    const moduleGrid = document.getElementById('module-grid');
    let draggedModule = null;

    function setupDragAndDrop() {
      const modules = document.querySelectorAll('#module-grid section');
      const isMobile = window.innerWidth < 640;

      modules.forEach(module => {
        if (!isMobile) {
          module.setAttribute('draggable', 'true');

          module.addEventListener('dragstart', (e) => {
            draggedModule = module;
            module.classList.add('dragging');
            e.dataTransfer.setData('text/plain', '');
          });

          module.addEventListener('dragend', () => {
            module.classList.remove('dragging');
            draggedModule = null;
          });

          module.addEventListener('dragover', (e) => {
            e.preventDefault();
          });

          module.addEventListener('dragenter', (e) => {
            e.preventDefault();
            module.classList.add('hover-transition');
          });

          module.addEventListener('dragleave', () => {
            module.classList.remove('hover-transition');
          });

          module.addEventListener('drop', (e) => {
            e.preventDefault();
            module.classList.remove('hover-transition');
            if (draggedModule && draggedModule !== module) {
              const allModules = Array.from(moduleGrid.children);
              const draggedIndex = allModules.indexOf(draggedModule);
              const targetIndex = allModules.indexOf(module);

              if (draggedIndex < targetIndex) {
                moduleGrid.insertBefore(draggedModule, module.nextSibling);
              } else {
                moduleGrid.insertBefore(draggedModule, module);
              }

              window.dispatchEvent(new Event('resize'));
            }
          });

          module.addEventListener('touchstart', (e) => {
            draggedModule = module;
            module.classList.add('dragging');
          });

          module.addEventListener('touchmove', (e) => {
            const target = e.target.closest('ul');
            if (!target || !target.matches('#token-list, #profit-pairs, #log-list, #chat-list, #gas-heatmap-list')) {
              e.preventDefault();
            }
            const touch = e.touches[0];
            const dropTarget = document.elementFromPoint(touch.clientX, touch.clientY)?.closest('#module-grid section');
            if (dropTarget && dropTarget !== draggedModule) {
              dropTarget.classList.add('hover-transition');
            }
          });

          module.addEventListener('touchend', (e) => {
            module.classList.remove('dragging');
            const touch = e.changedTouches[0];
            const target = document.elementFromPoint(touch.clientX, touch.clientY);
            const dropTarget = target?.closest('#module-grid section');
            if (dropTarget && dropTarget !== draggedModule) {
              const allModules = Array.from(moduleGrid.children);
              const draggedIndex = allModules.indexOf(draggedModule);
              const targetIndex = allModules.indexOf(dropTarget);

              if (draggedIndex < targetIndex) {
                moduleGrid.insertBefore(draggedModule, dropTarget.nextSibling);
              } else {
                moduleGrid.insertBefore(draggedModule, dropTarget);
              }

              window.dispatchEvent(new Event('resize'));
            }
            draggedModule = null;
            modules.forEach(m => m.classList.remove('hover-transition'));
          });
        }
      });
    }

    // Indicator toggle
    let isIndicatorEnabledHeader = false;
    let isIndicatorEnabledModal = false;

    // TradingView chart
    function initializeChart(containerId, symbol, interval = 'D', retries = 2) {
      const container = document.getElementById(containerId);
      const chartTitle = document.getElementById(containerId === 'chart-container-header' ? 'chart-title-header' : 'chart-title-modal');
      if (!container || !chartTitle) {
        console.error(`Container or chart title not found for ${containerId}`);
        return;
      }

      while (container.firstChild) {
        container.removeChild(container.firstChild);
      }

      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'chart-loading';
      loadingDiv.innerHTML = `
        <div class="loader"></div>
        <div class="ml-2">Loading ${symbol.replace('BINANCE:', '')} chart...</div>
      `;
      container.appendChild(loadingDiv);

      const isHeader = containerId === 'chart-container-header';
      const isIndicatorEnabled = isHeader ? isIndicatorEnabledHeader : isIndicatorEnabledModal;

      const initWidget = () => {
        try {
          const widgetConfig = {
            autosize: true,
            symbol: symbol,
            interval: interval,
            timezone: 'Etc/UTC',
            theme: 'dark',
            style: '1',
            locale: 'en',
            toolbar_bg: '#1e2727',
            enable_publishing: false,
            hide_top_toolbar: false,
            hide_side_toolbar: false,
            allow_symbol_change: true,
            container_id: containerId,
            overrides: {
              'paneProperties.background': '#1e2727',
              'paneProperties.vertGridProperties.color': 'rgba(0, 204, 0, 0.1)',
              'paneProperties.horzGridProperties.color': 'rgba(0, 204, 0, 0.1)',
              'mainSeriesProperties.candleStyle.upColor': '#00cc00',
              'mainSeriesProperties.candleStyle.downColor': '#cc0000',
              'mainSeriesProperties.candleStyle.borderUpColor': '#00cc00',
              'mainSeriesProperties.candleStyle.borderDownColor': '#cc0000',
            },
            onChartReady: () => {
              console.log(`Chart loaded for ${containerId} with symbol ${symbol}`);
              if (isIndicatorEnabled) {
                alert('Please manually add the "ICE KING Lite V1.0" indicator:\n1. Click Indicators (f(x)).\n2. Search "ICE KING Lite V1.0".\n3. Apply.');
              }
            },
            onError: (error) => {
              console.error(`Chart error for ${containerId} with symbol ${symbol}:`, error);
              if (retries > 0) {
                console.log(`Retrying (${retries} attempts left)...`);
                setTimeout(() => initializeChart(containerId, symbol, interval, retries - 1), 500);
              } else {
                loadingDiv.textContent = `Failed to load ${symbol.replace('BINANCE:', '')} chart.`;
              }
            }
          };

          const widget = new TradingView.widget(widgetConfig);
        } catch (error) {
          console.error(`Critical error initializing chart for ${containerId}:`, error);
          if (retries > 0) {
            setTimeout(() => initializeChart(containerId, symbol, interval, retries - 1), 500);
          } else {
            loadingDiv.textContent = `Critical failure loading ${symbol.replace('BINANCE:', '')} chart.`;
          }
        }
      };

      setTimeout(initWidget, 300);
    }

    // Fetch with retry
    async function fetchWithRetry(url, retries = 2, delay = 1000) {
      for (let i = 0; i <= retries; i++) {
        try {
          const response = await fetch(url, {
            method: 'GET',
            mode: 'cors',
            credentials: 'omit',
          });
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}, Text: ${response.statusText}`);
          }
          return await response.json();
        } catch (error) {
          if (i === retries) {
            console.error(`Failed to fetch ${url} after ${retries + 1} attempts:`, error);
            throw error;
          }
          console.warn(`Fetch attempt ${i + 1} failed for ${url}. Retrying in ${delay}ms: ${error.message}`);
          await new Promise(resolve => setTimeout(resolve, delay));
        }
      }
    }

    // Fetch ETH gas prices
    async function fetchGasPrices() {
      const apiKey = 'K3I98GFINF6K4EYRQNZCZD6KIIQ3BAAQ5T';
      const url = `https://api.etherscan.io/api?module=gastracker&action=gasoracle&apikey=${apiKey}`;
      try {
        const data = await fetchWithRetry(url);
        if (data.status === '1' && data.result) {
          return {
            safeGasPrice: parseInt(data.result.SafeGasPrice) || 10,
            proposeGasPrice: parseInt(data.result.ProposeGasPrice) || 15,
            fastGasPrice: parseInt(data.result.FastGasPrice) || 20,
            lastBlock: data.result.LastBlock || 'N/A',
            timestamp: new Date().getTime()
          };
        } else {
          throw new Error('Invalid gas price data');
        }
      } catch (error) {
        console.error('Failed to fetch gas prices:', error);
        return null;
      }
    }

    // Render ETH gas fee heatmap
    async function renderGasHeatmap() {
      const canvas = document.getElementById('gas-heatmap-canvas');
      const gasList = document.getElementById('gas-heatmap-list');
      const loader = document.getElementById('loader-gas');
      if (!canvas || !gasList || !loader) {
        console.error('[ERROR] Gas heatmap elements not found:', { canvas, gasList, loader });
        return;
      }

      const ctx = canvas.getContext('2d');
      if (!ctx) {
        console.error('[ERROR] Failed to get 2D context for gas heatmap canvas');
        loader.textContent = '> Failed to initialize canvas';
        loader.style.display = 'block';
        return;
      }

      let gasHistory = [];
      const maxHistory = 20;
      const margin = { top: 20, right: 10, bottom: 20, left: 40 };

      const resizeCanvas = () => {
        const dpr = window.devicePixelRatio || 1;
        canvas.width = canvas.offsetWidth * dpr;
        canvas.height = canvas.offsetHeight * dpr;
        canvas.style.width = `${canvas.offsetWidth}px`;
        canvas.style.height = `${canvas.offsetHeight}px`;
        ctx.scale(dpr, dpr);
      };

      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);

      const getColor = (intensity) => {
        if (intensity < 0.5) {
          const t = intensity * 2;
          const r = Math.round(0 + t * (204 - 0));
          const g = Math.round(204);
          const b = Math.round(0);
          return `rgb(${r}, ${g}, ${b})`;
        } else {
          const t = (intensity - 0.5) * 2;
          const r = Math.round(204);
          const g = Math.round(204 - t * (204 - 187));
          const b = Math.round(0 + t * (51 - 0));
          return `rgb(${r}, ${g}, ${b})`;
        }
      };

      const updateHeatmap = async () => {
        try {
          loader.style.display = 'block';
          gasList.innerHTML = '';

          const gasData = await fetchGasPrices();
          if (!gasData) {
            loader.textContent = '> Failed to load gas prices';
            loader.style.display = 'block';
            return;
          }

          gasHistory.push(gasData);
          if (gasHistory.length > maxHistory) gasHistory.shift();

          gasList.innerHTML = gasHistory.slice(-5).reverse().map(data => `
            <li class="p-2 rounded bg-gray-900">
              <div>Block: ${data.lastBlock}</div>
              <div>Safe: ${data.safeGasPrice} Gwei</div>
              <div>Propose: ${data.proposeGasPrice} Gwei</div>
              <div>Fast: ${data.fastGasPrice} Gwei</div>
              <div class="metric">Time: ${new Date(data.timestamp).toLocaleTimeString()}</div>
            </li>
          `).join('');

          ctx.clearRect(0, 0, canvas.width, canvas.height);

          const maxGas = Math.max(...gasHistory.map(d => Math.max(d.fastGasPrice, d.proposeGasPrice, d.safeGasPrice)), 100);
          const plotWidth = canvas.offsetWidth - margin.left - margin.right;
          const plotHeight = canvas.offsetHeight - margin.top - margin.bottom;
          const barWidth = Math.max(plotWidth / maxHistory / 3, 2);

          gasHistory.forEach((data, i) => {
            const x = margin.left + (i * plotWidth / maxHistory);
            const prices = [
              { value: data.safeGasPrice, color: '#00cc00' },
              { value: data.proposeGasPrice, color: '#ffbb33' },
              { value: data.fastGasPrice, color: '#cc0000' }
            ];

            prices.forEach((price, j) => {
              const intensity = price.value / maxGas;
              const height = (price.value / maxGas) * plotHeight * 0.9;
              const y = margin.top + plotHeight - height;
              ctx.fillStyle = getColor(intensity);
              ctx.fillRect(x + j * barWidth, y, barWidth - 1, height);
            });
          });

          ctx.fillStyle = '#e0f7fa';
          ctx.font = '10px Fira Code';
          ctx.textAlign = 'right';
          ctx.textBaseline = 'middle';
          const yTicks = [0, Math.round(maxGas / 2), maxGas];
          yTicks.forEach(tick => {
            const y = margin.top + plotHeight - (tick / maxGas) * plotHeight;
            ctx.fillText(`${tick} Gwei`, margin.left - 5, y);
          });

          ctx.textAlign = 'center';
          ctx.textBaseline = 'top';
          const latestTime = new Date(gasHistory[gasHistory.length - 1]?.timestamp);
          ctx.fillText(latestTime.toLocaleTimeString(), margin.left + plotWidth, margin.top + plotHeight + 5);

          loader.style.display = 'none';
          console.log('[DEBUG] Gas heatmap updated:', { gasHistoryLength: gasHistory.length, latestGasData: gasData });
        } catch (error) {
          console.error('[ERROR] Failed to update gas heatmap:', error);
          loader.textContent = '> Error loading gas heatmap';
          loader.style.display = 'block';
        }
      };

      updateHeatmap();
      setInterval(updateHeatmap, 60000);
    }

    // Main logic
    let isUsingMockData = false;

    const loadData = async () => {
      const backendApiUrl = 'https://apexomni-backend-fppm.onrender.com/api/crypto';
      const toggleDataSourceBtn = document.getElementById('toggle-data-source');
      if (isUsingMockData) {
        updateUI(mockTokens);
        toggleDataSourceBtn.textContent = 'Real Data';
        return;
      }

      try {
        const data = await fetchWithRetry(backendApiUrl);
        console.log('Raw backend response:', data);
        if (!Array.isArray(data) || data.length === 0) {
          throw new Error('Invalid or empty response from backend');
        }
        const ethData = data.find(token => token.symbol === 'ETH');
        if (ethData) {
          const gasData = await fetchGasPrices();
          if (gasData) {
            ethData.gasPrice = gasData.proposeGasPrice;
          }
        }
        updateUI(data);
        toggleDataSourceBtn.textContent = 'Mock Data';
        renderGasHeatmap();
      } catch (error) {
        console.error('Failed to load real data:', error);
        document.getElementById('live-price-header').textContent = `> Live Price: Error - ${error.message}`;
        document.getElementById('chart-title-header').textContent = 'Error';
        document.getElementById('chart-title-modal').textContent = 'Error';
        document.getElementById('loader-tokens').textContent = `> ${error.message}. Try Mock Data.`;
        document.getElementById('loader-tokens').style.display = 'block';
        toggleDataSourceBtn.textContent = 'Mock Data';
        document.getElementById('loader-gas').textContent = '> Failed to load gas prices';
      }
    };

    function updateUI(tokens) {
      document.getElementById('loader-tokens').style.display = 'none';

      const tokenList = document.getElementById('token-list');
      tokenList.innerHTML = tokens.map((token, index) => {
        const isPositive = token.price_change_percentage_24h >= 0;
        const rankFactor = index / (tokens.length - 1);
        const bgClass = isPositive ? `bg-green-${900 - Math.floor(rankFactor * 300)}` : `bg-red-${600 + Math.floor(rankFactor * 300)}`;
        const textClass = isPositive ? `text-green-${400 + Math.floor(rankFactor * 300)}` : `text-red-${500 + Math.floor(rankFactor * 300)}`;
        const symbol = `BINANCE:${token.symbol}USDT`;
        return `
          <li class="${bgClass} ${index === 0 ? 'selected-token' : ''}" data-symbol="${symbol}" data-tooltip="View ${token.symbol} chart">
            <div class="flex justify-between">
              <span>${token.name} (${token.symbol})</span>
              <span class="performance ${textClass}">${token.price_change_percentage_24h >= 0 ? '+' : ''}${token.price_change_percentage_24h.toFixed(2)}%</span>
            </div>
            <div class="metric">Price: $${token.current_price.toLocaleString()}</div>
            <div class="metric">Volume: ${token.total_volume.toLocaleString()} USD</div>
            <div class="metric">Supply: ${token.circulating_supply.toLocaleString()}</div>
            ${token.symbol === 'ETH' && token.gasPrice ? `<div class="metric">Gas: ${token.gasPrice} Gwei</div>` : ''}
          </li>
        `;
      }).join('');

      const profitPairs = document.getElementById('profit-pairs');
      const sortedTokens = [...tokens].sort((a, b) => b.price_change_percentage_24h - a.price_change_percentage_24h);
      const topToken = sortedTokens[0];
      const bottomToken = sortedTokens[sortedTokens.length - 1];
      profitPairs.innerHTML = `
        <li class="top-pair p-2 rounded bg-gray-900">
          <div>${topToken.name} (${topToken.symbol}): +${topToken.price_change_percentage_24h.toFixed(2)}%</div>
          <div class="metric">Price: $${topToken.current_price.toLocaleString()}</div>
          <div class="metric">Volume: ${topToken.total_volume.toLocaleString()} USD</div>
        </li>
        <li class="bottom-pair p-2 rounded bg-gray-900">
          <div>${bottomToken.name} (${bottomToken.symbol}): ${bottomToken.price_change_percentage_24h.toFixed(2)}%</div>
          <div class="metric">Price: $${bottomToken.current_price.toLocaleString()}</div>
          <div class="metric">Volume: ${bottomToken.total_volume.toLocaleString()} USD</div>
        </li>
      `;

      document.getElementById('live-price-header').textContent = `> Live Price: $${topToken.current_price.toLocaleString()} (${topToken.symbol})`;
      document.getElementById('live-price-modal').textContent = `> Live Price: $${topToken.current_price.toLocaleString()} (${topToken.symbol})`;

      const topPairs = document.getElementById('top-pairs');
      topPairs.innerHTML = tokens
        .filter(token => token.symbol && token.symbol !== 'USDT')
        .slice(0, 5)
        .map(token => `<li class="p-1 rounded-md">${token.symbol}/USDT (#${token.market_cap_rank})</li>`)
        .join('');

      const uniquePun = iceKingPuns[Math.floor(Math.random() * iceKingPuns.length)] || 'Chill out!';
      const marqueeContent = [
        ...tokens.slice(0, 5).map(token => `<span>[${token.symbol}] $${token.current_price.toLocaleString()} (${token.price_change_percentage_24h.toFixed(2)}%)</span>`),
        `<span>${uniquePun}</span>`
      ].join('');
      document.getElementById('ticker-marquee-header').innerHTML = marqueeContent.repeat(3);
      document.getElementById('ticker-marquee-modal').innerHTML = marqueeContent.repeat(3);
      document.getElementById('ticker-marquee-header').style.animationDuration = `${Math.max(80, tokens.length * 5)}s`;
      document.getElementById('ticker-marquee-modal').style.animationDuration = `${Math.max(80, tokens.length * 5)}s`;

      const topSymbol = `BINANCE:${topToken.symbol}USDT`;
      initializeChart('chart-container-header', topSymbol, 'D');
      initializeChart('chart-container-modal', topSymbol, 'D');
      document.getElementById('chart-title-header').setAttribute('data-symbol', topSymbol);
      document.getElementById('chart-title-header').textContent = topSymbol;
      document.getElementById('chart-title-modal').setAttribute('data-symbol', topSymbol);
      document.getElementById('chart-title-modal').textContent = topSymbol;
    }

    document.addEventListener('DOMContentLoaded', () => {
      const toggleDataSourceBtn = document.getElementById('toggle-data-source');
      const toggleIndicatorHeaderBtn = document.getElementById('toggle-indicator-header');
      const toggleIndicatorModalBtn = document.getElementById('toggle-indicator-modal');
      const toggleStickyHeader = document.getElementById('toggle-sticky-header');
      const toggleStickyModal = document.getElementById('toggle-sticky-modal');
      const chartModal = document.getElementById('chart-modal');
      const toggleDebugBtn = document.getElementById('toggle-debug');
      const tokenList = document.getElementById('token-list');

      setupDragAndDrop();
      loadData();

      toggleDataSourceBtn.addEventListener('click', () => {
        isUsingMockData = !isUsingMockData;
        loadData();
      });

      toggleIndicatorHeaderBtn.addEventListener('click', () => {
        isIndicatorEnabledHeader = !isIndicatorEnabledHeader;
        toggleIndicatorHeaderBtn.textContent = `${isIndicatorEnabledHeader ? 'Disable' : 'Enable'} Indicator`;
        const symbol = document.getElementById('chart-title-header').getAttribute('data-symbol');
        const interval = document.querySelector('#header-timeframe-1d').getAttribute('data-interval');
        initializeChart('chart-container-header', symbol, interval);
      });

      toggleIndicatorModalBtn.addEventListener('click', () => {
        isIndicatorEnabledModal = !isIndicatorEnabledModal;
        toggleIndicatorModalBtn.textContent = `${isIndicatorEnabledModal ? 'Disable' : 'Enable'} Indicator`;
        const symbol = document.getElementById('chart-title-modal').getAttribute('data-symbol');
        const interval = document.querySelector('#modal-timeframe-1d').getAttribute('data-interval');
        initializeChart('chart-container-modal', symbol, interval);
      });

      const timeframes = ['1min', '5min', '15min', '1hr', '1d'];
      timeframes.forEach(tf => {
        const headerBtn = document.getElementById(`header-timeframe-${tf}`);
        const modalBtn = document.getElementById(`modal-timeframe-${tf}`);
        const interval = headerBtn?.dataset.interval;

        if (headerBtn) {
          headerBtn.addEventListener('click', () => {
            document.querySelectorAll('#header-timeframe-' + timeframes.map(t => `#header-timeframe-${t}`).join(',')).forEach(btn => btn.classList.remove('active'));
            headerBtn.classList.add('active');
            const symbol = document.getElementById('chart-title-header').getAttribute('data-symbol');
            initializeChart('chart-container-header', symbol, interval);
          });
        }
        if (modalBtn) {
          modalBtn.addEventListener('click', () => {
            document.querySelectorAll('#modal-timeframe-' + timeframes.map(t => `#modal-timeframe-${t}`).join(',')).forEach(btn => btn.classList.remove('active'));
            modalBtn.classList.add('active');
            const symbol = document.getElementById('chart-title-modal').getAttribute('data-symbol');
            initializeChart('chart-container-modal', symbol, interval);
          });
        }
      });

      if (tokenList) {
        tokenList.addEventListener('click', (e) => {
          const li = e.target.closest('li');
          if (li && li.dataset.symbol) {
            const symbol = li.dataset.symbol;
            const interval = document.querySelector('#header-timeframe-1d').getAttribute('data-interval');
            initializeChart('chart-container-header', symbol, interval);
            initializeChart('chart-container-modal', symbol, interval);
            document.getElementById('chart-title-header').setAttribute('data-symbol', symbol);
            document.getElementById('chart-title-header').textContent = symbol;
            document.getElementById('chart-title-modal').setAttribute('data-symbol', symbol);
            document.getElementById('chart-title-modal').textContent = symbol;

            const tokenListItems = document.querySelectorAll('#token-list li');
            tokenListItems.forEach(item => item.classList.remove('selected-token'));
            li.classList.add('selected-token');
            console.log(`Switched to token: ${symbol}`);
          }
        });
      }

      if (toggleStickyHeader) {
        toggleStickyHeader.addEventListener('click', () => {
          chartModal.classList.add('active');
          toggleStickyHeader.textContent = 'Chart Docked';
          setTimeout(() => {
            toggleStickyHeader.textContent = 'Dock Chart';
          }, 1000);
          const symbol = document.getElementById('chart-title-header').getAttribute('data-symbol');
          const interval = document.querySelector('#header-timeframe-1d').getAttribute('data-interval');
          initializeChart('chart-container-modal', symbol, interval);
        });
      }
      if (toggleStickyModal) {
        toggleStickyModal.addEventListener('click', () => {
          chartModal.classList.remove('active');
          toggleStickyModal.textContent = 'Chart Undocked';
          setTimeout(() => {
            toggleStickyModal.textContent = 'Undock Chart';
          }, 1000);
          const symbol = document.getElementById('chart-title-modal').getAttribute('data-symbol');
          const interval = document.querySelector('#modal-timeframe-1d').getAttribute('data-interval');
          initializeChart('chart-container-header', symbol, interval);
        });
      }

      toggleDebugBtn.addEventListener('click', () => {
        isDebugMode = !isDebugMode;
        toggleDebugBtn.textContent = `${isDebugMode ? 'Disable' : 'Enable'} Debug`;
      });
    });

    const mockTokens = [
      { id: 'bitcoin', name: 'Bitcoin', symbol: 'BTC', current_price: 60000, total_volume: 4500000, price_change_percentage_24h: 5.2, market_cap: 1500000000, circulating_supply: 19000000, source: 'Mock', high_24h: 61000, low_24h: 59000, market_cap_rank: 1 },
      { id: 'ethereum', name: 'Ethereum', symbol: 'ETH', current_price: 4000, total_volume: 3000000, price_change_percentage_24h: -2.1, market_cap: 7500000000, circulating_supply: 120000000, source: 'Mock', high_24h: 4100, low_24h: 3900, market_cap_rank: 2, gasPrice: 30 },
      { id: 'constitutiondao', name: 'ConstitutionDAO', symbol: 'PEOPLE', current_price: 0.01962, total_volume: 135674.745, price_change_percentage_24h: 41.10, market_cap: 99400658.805, circulating_supply: 5066406500, source: 'Mock', high_24h: 0.020, low_24h: 0.018, market_cap_rank: 150 }
    ];

    const iceKingPuns = [
      "Everything is Going to be okay!",
      "Time to freeze the market!",
      "Ice to meet you, traders!",
      "I‚Äôm the coolest king around!",
      "Snow way I‚Äôm missing this trade!",
      "Freeze your doubts, let‚Äôs trade!",
      "I‚Äôm skating through the market!",
      "Cold cash, hot trades!",
      "My portfolio‚Äôs cooler than ice!",
      "Chill out!",
      "Ice King‚Äôs here to rule the charts!",
      "Let‚Äôs make it snow profits!",
      "I‚Äôm frosting the competition!",
      "Cool trades, warm wins!"
    ];

    let isDebugMode = false;
  </script>
</body>
</html>
