<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>QUANTUMI • BTC Hash Studio (Synced)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#0d0f12" />
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Sixtyfour:BLED,SCAN@0..100,-53..100&family=Sora:wght@100..800&display=swap" rel="stylesheet" />
    <style>
      *, *::before, *::after { box-sizing: border-box; }
      :root{
        --bg:#111215; --fg:#f7f7f7; --muted:#cfd3d8; --accent:#00FF00;
        --border:rgba(0,255,0,.28); --card:#0d0f12; --soft:rgba(0,255,0,.16);
        --focus:#00FF00; --danger:#ff6161;
        --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom);
      }
      html,body{ height:100%; color:var(--fg); font-family:'Sora',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
      body{ display:flex; flex-direction:column; min-height:100vh; overflow-x:hidden; background:linear-gradient(145deg,#111215,#0b0c0e); }
      header{ position:sticky; top:0; z-index:40; padding-top:var(--safe-top); background:linear-gradient(180deg, rgba(17,18,21,.72), rgba(17,18,21,.4)); border-bottom:1px solid rgba(255,255,255,.08); backdrop-filter:saturate(180%) blur(18px); -webkit-backdrop-filter:saturate(180%) blur(18px); }
      .brand{ display:flex; align-items:center; gap:.6rem; padding:12px 16px 10px; flex-wrap:wrap; }
      .logo{ font-family:'Sixtyfour',sans-serif; font-size:clamp(20px,4vw,32px); letter-spacing:2px; text-shadow:0 1px 6px #000c; }
      .sub{ font-size:12px; opacity:.75; }
      .right{ margin-left:auto; display:flex; align-items:center; gap:.6rem; flex-wrap:wrap; }
      main{ flex:1; display:flex; flex-direction:column; gap:12px; padding:12px 14px; }
      .panel{ background:rgba(13,15,18,.5); backdrop-filter:saturate(180%) blur(12px); -webkit-backdrop-filter:saturate(180%) blur(12px); border:1px solid rgba(255,255,255,.08); border-radius:12px; box-shadow:0 2px 20px #0006; position:relative; overflow:hidden; }
      #stagePanel{ flex:1; min-height:60vh; }
      .stage{ position:absolute; inset:0; }
      .overlay{ position:absolute; left:12px; top:12px; display:flex; flex-wrap:wrap; gap:6px; pointer-events:none; }
      .chip{ display:flex; align-items:center; gap:6px; pointer-events:auto; background:rgba(0,0,0,.55); border:1px solid var(--border); border-radius:10px; padding:6px 8px; font-size:12px; }
      .legend{ position:absolute; left:12px; right:12px; bottom:12px; display:flex; gap:6px; flex-wrap:wrap; justify-content:center; pointer-events:none; }
      .legend .swatch{ width:12px; height:12px; border-radius:3px; margin-right:4px; border:1px solid rgba(255,255,255,.4); }
      canvas#btc-hash-canvas{ width:100%; height:100%; display:block; background:#000; touch-action:none; }
      .mobile-fs-btn{ display:none; position:absolute; right:12px; top:12px; background:rgba(0,255,0,.15); border:1px solid rgba(0,255,0,.3); color:var(--accent); border-radius:8px; padding:6px; z-index:20; }
      @media (max-width:640px){ .mobile-fs-btn{ display:inline-flex; } }
      .aside{ display:flex; flex-direction:column; gap:10px; overflow:auto; padding:10px; scrollbar-color:#333 #111; flex:0 0 auto; }
      .card{ background:rgba(12,15,18,.5); backdrop-filter:saturate(160%) blur(10px); -webkit-backdrop-filter:saturate(160%) blur(10px); border:1px solid rgba(255,255,255,.06); border-radius:10px; padding:10px; }
      .log{ list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:8px; }
      .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, monospace; background:#111; border:1px solid rgba(255,255,255,.08); padding:2px 6px; border-radius:6px; font-size:11px; }
      footer{ flex-shrink:0; border-top:1px solid rgba(255,255,255,.08); background:rgba(14,17,20,.6); backdrop-filter:saturate(180%) blur(12px); -webkit-backdrop-filter:saturate(180%) blur(12px); padding:10px 14px calc(10px + var(--safe-bottom)); font-size:12px; color:#aaa; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px; }
      /* Controls */
      #controls-toggle{ display:inline-flex; margin:0 14px 12px; }
      .controls-rail{ padding:10px 14px 12px; flex-shrink:0; transition:max-height .25s ease; overflow:hidden; }
      .controls-rail[aria-hidden="true"]{ max-height:0; padding:0 14px; }
      .controls-rail[aria-hidden="false"]{ max-height:80vh; overflow-y:auto; padding:10px 14px 12px; }
      .controls{ width:100%; display:grid; grid-template-columns: repeat(auto-fit, minmax(240px,1fr)); gap:10px; background:rgba(20,20,20,.45); backdrop-filter:saturate(180%) blur(16px); -webkit-backdrop-filter:saturate(180%) blur(16px); border:1px solid rgba(255,255,255,.1); border-radius:16px; padding:14px; box-shadow:0 2px 20px #0006; }
      .btn-row{ display:flex; flex-wrap:wrap; gap:8px; }
      .ctrl{ width:100%; display:flex; flex-wrap:wrap; align-items:center; gap:8px; background:rgba(12,15,18,.6); backdrop-filter:saturate(160%) blur(12px); -webkit-backdrop-filter:saturate(160%) blur(12px); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px; min-height:52px; }
      .ctrl label{ font-size:12px; white-space:nowrap; opacity:.9; }
      .ctrl input[type="text"], .ctrl input[type="number"], .ctrl input[type="range"], .ctrl select, .ctrl input[type="email"], .ctrl input[type="file"]{ flex:1 1 auto; min-width:0; background:#000; border:1.5px solid #444; color:#fff; border-radius:6px; padding:10px; outline:none; }
      .ctrl input[type="text"]:focus, .ctrl input[type="number"]:focus, .ctrl input[type="range"]:focus, .ctrl select:focus, .ctrl input[type="email"]:focus, .ctrl input[type="file"]:focus{ border-color:var(--accent); }
      .ctrl input[type="range"]{ padding:0; -webkit-appearance:none; appearance:none; background:transparent; }
      .ctrl input[type="range"]::-webkit-slider-runnable-track{ height:4px; background:rgba(0,255,0,.3); border-radius:2px; }
      .ctrl input[type="range"]::-webkit-slider-thumb{ -webkit-appearance:none; width:14px; height:14px; border-radius:50%; background:var(--accent); cursor:pointer; margin-top:-5px; }
      .ctrl input[type="range"]::-moz-range-track{ height:4px; background:rgba(0,255,0,.3); border-radius:2px; }
      .ctrl input[type="range"]::-moz-range-thumb{ width:14px; height:14px; border-radius:50%; background:var(--accent); cursor:pointer; }
      .btn{ background:#111; border:1px solid var(--accent); color:#fff; border-radius:6px; padding:8px 12px; cursor:pointer; transition:background .18s, color .18s, transform .06s; min-width:44px; min-height:44px; }
      .btn:hover, .btn:focus{ background:var(--accent); color:#111; }
      .btn:active{ transform: translateY(1px); }
      /* Fullscreen */
      .fs-target:fullscreen, .fs-target:-webkit-full-screen{ background:#000; width:100%; height:100%; }
      .fs-btn-on{ display:none; } .fs-active .fs-btn-on{ display:inline-flex; } .fs-active .fs-btn-off{ display:none; }
      @media (max-width: 640px){
        main{ padding:8px; gap:8px; }
        #stagePanel{ min-height:54vh; }
        .panel,.aside{ width:100%; }
        .chip{ font-size:11px; }
      }
    </style>

    <!-- three.js r128 for compatibility -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/exporters/FBXExporter.js"></script>
  </head>
  <body>
    <a class="skip-link" href="#main">Skip to content</a>
    <header>
      <div class="brand">
        <div class="logo">QUANTUMI</div>
        <div class="sub">BTC Hash Studio • synced to index</div>
        <div class="right">
          <a href="https://quantumi.space" class="btn" rel="noopener">Home</a>
          <div class="sub">v2.3</div>
        </div>
      </div>
      <button id="controls-toggle" class="btn" type="button" aria-expanded="false" aria-controls="controls-rail">Controls</button>
    </header>

    <main id="main">
      <section class="panel fs-target" id="stagePanel" aria-label="3D stage">
        <div class="stage">
          <button id="mobile-fs-toggle" class="mobile-fs-btn" aria-label="Toggle fullscreen">⤢</button>
          <div class="overlay" id="metrics">
            <div class="chip" id="m-price">Price —</div>
            <div class="chip" id="m-change">24h —</div>
            <div class="chip" id="m-hashrate">Hashrate —</div>
            <div class="chip" id="m-diff">Difficulty —</div>
            <div class="chip" id="m-mode">Mode — Original</div>
            <div class="chip" id="m-status">Status — Init…</div>
          </div>
          <canvas id="btc-hash-canvas" aria-label="BTC hash visualization"></canvas>
          <div class="legend" id="legend" aria-live="polite"></div>
        </div>
      </section>

      <aside class="panel aside">
        <div class="card">
          <div class="flex items-center gap-3">
            <strong>Hash Log</strong><span class="text-gray-400">Latest 10</span>
            <button class="btn ml-auto" id="toggle-log">Toggle</button>
          </div>
          <ul id="hash-log" class="log" aria-live="polite"></ul>
        </div>
        <div class="card text-sm text-gray-300">
          <div class="mb-1 font-semibold">Tips</div>
          <ul class="list-disc ml-5 space-y-1">
            <li>‘Original’ mapping is live market-derived (time/price/volume).</li>
            <li>Spiral/Sphere/Helix use a BTC hash (Latest/Manual/Random/Generate).</li>
            <li>Use <b>Fullscreen</b> for presentations; works on mobile too.</li>
          </ul>
        </div>
      </aside>
    </main>

    <div id="controls-rail" class="controls-rail" aria-hidden="false">
      <div class="controls">
        <div class="ctrl" title="Mapping from data to space. ‘Original’ uses time→Z, price→X, volume→Y.">
          <label>Mapping</label>
          <select id="mapping">
            <option value="original" selected>Original (Time/Price/Volume)</option>
            <option value="spiral">Spiral (time-curve)</option>
            <option value="sphere">Sphere (volatility radius)</option>
            <option value="helix">Helix (momentum tilt)</option>
          </select>
        </div>
        <div class="ctrl" title="Instances per data point.">
          <label>Density</label>
          <input type="range" id="density" min="1" max="200" value="60" />
        </div>
        <div class="ctrl" title="Point size for dot clouds.">
          <label>Point Size</label>
          <input type="range" id="pointSize" min="0.02" max="0.6" step="0.02" value="0.12" />
        </div>
        <div class="ctrl" title="Color mode for clouds/instances.">
          <label>Theme</label>
          <select id="theme">
            <option value="original" selected>Original</option>
            <option value="heatmap">Heatmap (volatility)</option>
            <option value="lifecycle">Lifecycle (volume)</option>
          </select>
        </div>
        <div class="ctrl" title="Paste a hash, or use the latest block. Used when Mapping ≠ Original.">
          <label>Hash</label>
          <input id="hashInput" type="text" placeholder="Paste a block/tx hash…" inputmode="latin" autocomplete="off" />
          <button class="btn" id="btnLatest" title="Use latest block-derived hash">Latest</button>
          <button class="btn" id="btnRandom" title="Use random hash">Random</button>
          <button class="btn" id="btnGenerate" title="Generate from price">Generate</button>
        </div>
        <div class="ctrl" title="Export the current scene and data.">
          <label>Export</label>
          <button class="btn" id="export-fbx">FBX</button>
          <button class="btn" id="export-png">PNG</button>
          <button class="btn" id="export-csv">CSV</button>
          <button class="btn right" id="reset-view" title="Reset camera">Reset</button>
        </div>
      </div>
    </div>

    <footer>
      <span>© 2025 <span style="font-family:'Sixtyfour',sans-serif">QUANTUMI</span> — All Rights Reserved.</span>
      <a href="https://www.instagram.com/quantumi.space/" target="_blank" rel="noopener" class="text-green-400 underline">Instagram</a>
    </footer>

    <script>
      // --- Utils & globals (mirrors index.html behavior) ----------------------
      const $ = (id) => document.getElementById(id);
      const nfUSD = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 2 });
      const nfPct = new Intl.NumberFormat('en-US', { style: 'percent', maximumFractionDigits: 2 });
      const canvas = $('btc-hash-canvas');

      let renderer, scene, camera, controls;
      let dotClouds = []; let colorLegend = [];

      // Theme helpers (Original/Heatmap/Lifecycle)
      const themes = {
        original: ['#00ff00','#66ff66','#bbffbb'],
        heatmap(v, vol, minV, maxV){ // volatility based
          const t = Math.min(1, Math.max(0, (v-0)/(10-0)));
          const r = Math.round(255 * t), g = Math.round(255 * (1-t));
          return `#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}00`;
        },
        lifecycle(vol, minV, maxV){
          const t = (vol-minV)/(maxV-minV+1e-6);
          const c = Math.round(255 * (0.3 + 0.7*t));
          return `#00${c.toString(16).padStart(2,'0')}ff`;
        }
      };
      const getThemeColor = (volatility, volume, minVolume, maxVolume) => {
        const mode = $('theme').value;
        if (mode === 'heatmap') return themes.heatmap(volatility, volume, minVolume, maxVolume);
        if (mode === 'lifecycle') return themes.lifecycle(volume, minVolume, maxVolume);
        return themes.original[0];
      };

      // --- Data fetch (lightweight versions used in index.html) --------------
      async function fetchWithRetry(url, opts = {}, retries = 2, delay = 600) {
        for (let i = 0; i <= retries; i++) {
          try { const r = await fetch(url, opts); if (!r.ok) throw new Error(`${r.status}`); return await r.json(); }
          catch (e){ if (i === retries) throw e; await new Promise(res=>setTimeout(res, delay*Math.pow(2,i))); }
        }
      }
      async function fetchTextWithRetry(url, retries = 2, delay = 600) {
        for (let i = 0; i <= retries; i++) {
          try { const r = await fetch(url); if (!r.ok) throw new Error(`${r.status}`); return await r.text(); }
          catch (e){ if (i === retries) throw e; await new Promise(res=>setTimeout(res, delay*Math.pow(2,i))); }
        }
      }
      async function fetchBTCPrice(){
        try { const d = await fetchWithRetry('https://api.coingecko.com/api/v3/coins/bitcoin');
          return { price:d.market_data.current_price.usd, volume:d.market_data.total_volume.usd };
        } catch { return { price:60000, volume:4_500_000 }; }
      }
      async function fetchBTCHistorical(){ // 24h OHLC-lite
        try { return await fetchWithRetry('https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=1'); }
        catch { return null; }
      }
      async function fetchBTCHashRate(){ try { return parseFloat(await fetchTextWithRetry('https://api.blockchain.info/q/hashrate?cors=true'))/1e9; } catch { return 0; } }
      async function fetchBTCDifficulty(){ try { return parseFloat(await fetchTextWithRetry('https://api.blockchain.info/q/getdifficulty?cors=true')); } catch { return 0; } }

      // --- Hash helpers (matches index) --------------------------------------
      function generateHashFromPrice(price){
        const s = String(price);
        let h=''; for(let i=0;i<64;i++){ h += (s.charCodeAt(i%s.length)%16).toString(16); }
        return h;
      }
      function addHashLog(hash, time){
        const el = document.createElement('li');
        el.innerHTML = `<span class="kbd">${hash.slice(0,16)}…</span> <span class="text-gray-400 ml-2">${time}</span>`;
        $('hash-log').prepend(el);
        while ($('hash-log').children.length > 10) $('hash-log').lastChild.remove();
      }
      function updateLegend(){
        const el = $('legend'); el.innerHTML = '';
        colorLegend.slice(-6).forEach((c)=>{
          const item = document.createElement('div'); item.className='chip';
          item.innerHTML = `<span class="swatch" style="background:${c.color}"></span>
            <span>$${c.price.toLocaleString()}</span>
            <span class="text-gray-400">${c.time}</span>`;
          el.appendChild(item);
        });
      }

      // --- 3D init (ported from index) ---------------------------------------
      function init3D(){
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, 1, 0.1, 2000);
        renderer = new THREE.WebGLRenderer({ canvas, antialias:true, alpha:false, preserveDrawingBuffer:true });
        resize();
        camera.position.set(0,0,10);
        const amb = new THREE.AmbientLight(0xffffff,0.6); scene.add(amb);
        const dir = new THREE.DirectionalLight(0xffffff,0.8); dir.position.set(5,10,7.5); scene.add(dir);
        const axes = new THREE.AxesHelper(10); scene.add(axes);
        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true; controls.dampingFactor = 0.1; controls.enablePan = true; controls.panSpeed = 0.5; controls.autoRotate = true; controls.autoRotateSpeed = 2.0;
        window.addEventListener('resize', ()=>{ clearTimeout(init3D._rt); init3D._rt=setTimeout(resize,120); });
        function resize(){ const w=canvas.clientWidth, h=canvas.clientHeight; renderer.setSize(w,h,false); camera.aspect = w/h || 1; camera.updateProjectionMatrix(); }
      }

      // --- Renderers (Original vs Hash mappings) -----------------------------
      function clearClouds(){ dotClouds.forEach(c=>scene.remove(c)); dotClouds=[]; }

      async function drawOriginalFromMarket(){
        const data = await fetchBTCHistorical(); if (!data) return;
        const prices = data.prices || []; const volumes = data.total_volumes || []; const timestamps = prices.map(p=>p[0]);
        if (prices.length<2) return;
        const minTime = timestamps[0], maxTime = timestamps[timestamps.length-1];
        const minPrice = Math.min(...prices.map(p=>p[1])), maxPrice = Math.max(...prices.map(p=>p[1]));
        const minVolume = Math.min(...volumes.map(v=>v[1])), maxVolume = Math.max(...volumes.map(v=>v[1]));
        const latestPrice = prices[prices.length-1][1]; const latestVolume = volumes[volumes.length-1][1];
        const recent = prices.slice(-10).map(p=>p[1]);
        const volatility = ((Math.max(...recent)-Math.min(...recent))/latestPrice)*100;
        const cloudColorHex = getThemeColor(volatility, latestVolume, minVolume, maxVolume);
        const cloudColor = new THREE.Color(cloudColorHex);
        const pointsPerCloud = parseInt($('density').value,10);
        const positions=[]; const colors=[];
        for(let i=0;i<prices.length;i++){
          const t = timestamps[i]; const price = prices[i][1]; const vol = volumes[i][1];
          const z = ((t-minTime)/(maxTime-minTime))*20-10;
          const x = ((price-minPrice)/(maxPrice-minPrice))*20-10;
          const y = ((vol-minVolume)/(maxVolume-minVolume))*20-10;
          for(let j=0;j<pointsPerCloud;j++){
            positions.push(x+(Math.random()-.5), y+(Math.random()-.5), z+(Math.random()-.5));
            colors.push(cloudColor.r, cloudColor.g, cloudColor.b);
          }
        }
        const geo = new THREE.BufferGeometry();
        geo.setAttribute('position', new THREE.Float32BufferAttribute(positions,3));
        geo.setAttribute('color', new THREE.Float32BufferAttribute(colors,3));
        const mat = new THREE.PointsMaterial({ size: parseFloat($('pointSize').value), vertexColors:true, transparent:true, opacity:1 });
        const cloud = new THREE.Points(geo,mat); scene.add(cloud); dotClouds.push(cloud);
        dotClouds.slice(0,-1).forEach(c=>c.material.opacity = Math.max(.12, c.material.opacity - .06));
        const latestTime = new Date(timestamps[timestamps.length-1]).toLocaleTimeString();
        colorLegend.push({ color:cloudColorHex, price:latestPrice, volume:latestVolume, time:latestTime }); updateLegend();
        $('m-price').textContent = `Price — ${nfUSD.format(latestPrice)}`;
        $('m-hashrate').textContent = `Hashrate — ${(await fetchBTCHashRate()).toFixed(2)} EH/s`;
        $('m-diff').textContent = `Difficulty — ${(await fetchBTCDifficulty()).toLocaleString()}`;
      }

      function layoutFromHash(hash, mapping){
        const vals = Array.from(hash).map(ch=>parseInt(ch,16));
        const N = 256; const positions=[]; const colors=[];
        const base = new THREE.Color(themes.original[dotClouds.length % themes.original.length]);
        for(let i=0;i<N;i++){
          const v = vals[i % vals.length] / 15; let x,y,z;
          if(mapping==='spiral'){ const a=i*.28, r=2+v*4; x=Math.cos(a)*r; y=Math.sin(a)*r; z=(i/N)*16-8; }
          else if(mapping==='sphere'){ const phi=Math.acos(1-(2*(i+.5))/N); const theta=Math.PI*(1+Math.sqrt(5))*(i+v); const R=6*(.6+.4*v); x=R*Math.sin(phi)*Math.cos(theta); y=R*Math.sin(phi)*Math.sin(theta); z=R*Math.cos(phi); }
          else if(mapping==='helix'){ const a=(i/N)*Math.PI*8; x=Math.cos(a)*5; y=Math.sin(a)*5; z=(i/N)*20-10+(v-.5); }
          else{ const a=i*.28, r=2+v*4; x=Math.cos(a)*r; y=Math.sin(a)*r; z=(i/N)*16-8; }
          positions.push(x,y,z); colors.push(base.r, base.g, base.b);
        }
        const geo=new THREE.BufferGeometry();
        geo.setAttribute('position', new THREE.Float32BufferAttribute(positions,3));
        geo.setAttribute('color', new THREE.Float32BufferAttribute(colors,3));
        const mat=new THREE.PointsMaterial({ size: parseFloat($('pointSize').value), vertexColors:true, transparent:true, opacity:1 });
        const cloud=new THREE.Points(geo,mat); scene.add(cloud); dotClouds.push(cloud);
        dotClouds.slice(0,-1).forEach(c=>c.material.opacity = Math.max(.12, c.material.opacity - .06));
        updateLegend();
      }

      // --- Controls -----------------------------------------------------------
      function animate(){ requestAnimationFrame(animate); controls && controls.update(); renderer.render(scene,camera); }
      function resetView(){ camera.position.set(0,0,10); controls.target.set(0,0,0); controls.update(); }

      document.addEventListener('DOMContentLoaded', async () => {
        // drawer toggle
        const drawerBtn = $('controls-toggle'); const rail = $('controls-rail');
        if (drawerBtn && rail) drawerBtn.addEventListener('click',()=>{ const open = drawerBtn.getAttribute('aria-expanded')==='true'; drawerBtn.setAttribute('aria-expanded', String(!open)); rail.setAttribute('aria-hidden', String(open)); });

        init3D(); animate();
        // initial draw (Original)
        await drawOriginalFromMarket();
        $('m-status').textContent = 'Status — Ready';

        // mapping switch
        $('mapping').addEventListener('change', async (e)=>{
          clearClouds(); $('m-mode').textContent = `Mode — ${e.target.value}`;
          if (e.target.value === 'original') await drawOriginalFromMarket();
          else {
            const hv = $('hashInput').value.trim() || generateHashFromPrice((await fetchBTCPrice()).price);
            const h = hv.replace(/[^0-9a-f]/gi,'').padEnd(64,'0').slice(0,64);
            layoutFromHash(h, e.target.value);
            addHashLog(h, new Date().toLocaleTimeString());
          }
        });

        // density & size live updates
        $('density').addEventListener('input', async ()=>{ if ($('mapping').value==='original'){ clearClouds(); await drawOriginalFromMarket(); } });
        $('pointSize').addEventListener('input', ()=>{ dotClouds.forEach(c=>c.material.size=parseFloat($('pointSize').value)); });
        $('theme').addEventListener('change', async ()=>{ if ($('mapping').value==='original'){ clearClouds(); await drawOriginalFromMarket(); }});

        // Hash controls (keep modifiable)
        $('btnGenerate').addEventListener('click', async ()=>{
          const { price } = await fetchBTCPrice(); const h = generateHashFromPrice(price);
          $('hashInput').value = h; if ($('mapping').value!=='original'){ clearClouds(); layoutFromHash(h, $('mapping').value); addHashLog(h, new Date().toLocaleTimeString()); }
        });
        $('btnRandom').addEventListener('click', ()=>{
          const h = Array.from({length:64},()=>Math.floor(Math.random()*16).toString(16)).join('');
          $('hashInput').value = h; if ($('mapping').value!=='original'){ clearClouds(); layoutFromHash(h, $('mapping').value); addHashLog(h, new Date().toLocaleTimeString()); }
        });
        $('btnLatest').addEventListener('click', async ()=>{
          // Use latest price to seed a 64-hex hash (matches index.html approach)
          const { price } = await fetchBTCPrice(); const h = generateHashFromPrice(price);
          $('hashInput').value = h; if ($('mapping').value!=='original'){ clearClouds(); layoutFromHash(h, $('mapping').value); addHashLog(h, new Date().toLocaleTimeString()); }
        });
        $('hashInput').addEventListener('change', ()=>{
          const hv = $('hashInput').value.trim(); if (!hv) return;
          const h = hv.replace(/[^0-9a-f]/gi,'').padEnd(64,'0').slice(0,64);
          if ($('mapping').value!=='original'){ clearClouds(); layoutFromHash(h, $('mapping').value); addHashLog(h, new Date().toLocaleTimeString()); }
        });

        // Exporters
        $('export-fbx').addEventListener('click', ()=>{
          const grp = new THREE.Group(); dotClouds.forEach(c=>grp.add(c.clone()));
          const exporter = new THREE.FBXExporter(); const result = exporter.parse(grp);
          const blob = new Blob([result], { type: 'text/plain' }); const a = document.createElement('a');
          a.href = URL.createObjectURL(blob); a.download = 'btc_hash_visualization.fbx'; a.click();
        });
        $('export-png').addEventListener('click', ()=>{ const a = document.createElement('a'); a.href = canvas.toDataURL('image/png'); a.download = 'btc_hash.png'; a.click(); });
        $('export-csv').addEventListener('click', ()=>{
          const rows=['x,y,z']; dotClouds.forEach(c=>{
            const pos = c.geometry.getAttribute('position'); for(let i=0;i<pos.count;i++){ rows.push(`${pos.getX(i)},${pos.getY(i)},${pos.getZ(i)}`); }
          });
          const blob = new Blob([rows.join('\n')], {type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='btc_hash_points.csv'; a.click();
        });
        $('reset-view').addEventListener('click', resetView);

        // Metrics updates (price/change/hashrate/diff)
        try{
          const {price} = await fetchBTCPrice(); $('m-price').textContent = `Price — ${nfUSD.format(price)}`;
          const hr = await fetchBTCHashRate(); $('m-hashrate').textContent = `Hashrate — ${hr.toFixed(2)} EH/s`;
          const df = await fetchBTCDifficulty(); $('m-diff').textContent = `Difficulty — ${df.toLocaleString()}`;
          $('m-change').textContent = `24h — updating…`;
        }catch{}
      });

      // Simple RAF loop label
      (function stamp(){ const el=$('m-status'); if(!el) return; let tick=0; function step(){ tick=(tick+1)%60; requestAnimationFrame(step);} step(); })();
    </script>
  </body>
</html>
